برای اضافه کردن چند زبان در پروژه از معماری i18n استفاده کردم.
به همین منظور یک فولدر به نام i18n ایجاد شد.
داخل این فولدر دو فایل middleware.py و translator.py قرار دارد.
در فایل translator.py از ماژول gettext برای استخراج و مدیریت ترجمه‌ها استفاده شده است.
هدف این بود که متن خطاها و پیام‌ها مستقیماً داخل کد اصلی نوشته نشوند.
این کار باعث تمیزتر شدن ساختار پروژه و قابلیت نگهداری بهتر آن شد.
برای جلوگیری از تداخل ترجمه بین درخواست‌های همزمان از contextvars استفاده شد.
به این صورت هر درخواست context جداگانه‌ای برای زبان خود دارد.
برای مدیریت مسیر فایل‌های ترجمه از pathlib استفاده شده است.
مسیر پوشه‌ای که فایل‌های ترجمه هر زبان در آن قرار دارد به صورت داینامیک تنظیم می‌شود.
چند تابع برای ست کردن زبان فعال نوشته شده است.
همچنین تابعی برای گرفتن متن ترجمه‌شده تعریف شده است.
یک تابع نیز برای ریست یا پاک کردن زبان فعال در context در نظر گرفته شده است.
برای نمایش متن ترجمه‌شده از gettext استفاده می‌شود.
یک Middleware به نام LanguageMiddleware در فایل middleware.py نوشته شده است.
این Middleware روی تمام endpointها اجرا می‌شود.
در این Middleware زبان از header یا پارامتر درخواست گرفته می‌شود.
سپس زبان فعال برای همان request در context تنظیم می‌شود.
یک فولدر به نام messages برای نگهداری متن‌های اصلی ایجاد شد.
در ابتدا یک کلاس Messages نوشتم و متن‌ها را به صورت string ثابت داخل آن قرار دادم.
اما این روش در زمان استفاده در endpointها به درستی کار نمی‌کرد.
مشکل این بود که gettext روی آن‌ها اعمال نمی‌شد.
در ادامه متوجه شدم که باید متن‌ها را داخل متد قرار بدهم.
برای این کار از دکوراتور staticmethod استفاده شد.
در هر endpoint متن‌ها به صورت متد از کلاس Messages فراخوانی می‌شوند.
به این صورت هنگام اجرا gettext روی آن‌ها اعمال می‌شود.
یک پوشه به نام locales برای نگهداری فایل‌های ترجمه ساخته شد.
برای هر زبان یک ساختار استاندارد شامل پوشه LC_MESSAGES ایجاد شد.
در هر زبان دو فایل با پسوند po و mo وجود دارد.
فایل po برای ویرایش انسانی ترجمه‌ها استفاده می‌شود.
فایل mo نسخه کامپایل‌شده و قابل خواندن توسط ماشین است.
برای تبدیل فایل‌های po به mo یک اسکریپت به نام compile_translator.py نوشته شد.
این اسکریپت تمام فایل‌های po را پیدا کرده و آن‌ها را به mo تبدیل می‌کند.
در نهایت سیستم ترجمه به صورت سراسری و بدون تداخل بین درخواست‌ها کار می‌کند.